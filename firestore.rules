rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset enforces a security model based on Authorization Independence, where
     * a document's authorization data is denormalized directly onto it. This avoids costly and slow
     * cross-document `get()` calls in rules. User-specific data is strictly owned, while shared academic
     * data (like assignments and projects) uses denormalized maps of user IDs (`studentUids`, `teacherUids`)
     * to grant access to specific groups of users.
     *
     * Data Structure: User data, including specific student or teacher profiles, is nested under
     * `/users/{userId}`. All other academic entities (batches, courses, assignments, submissions) are
     * organized into their own top-level collections for a flat, scalable structure.
     *
     * Key Security Decisions:
     * - User Enumeration is disabled by denying `list` access on the `/users` collection.
     * - A user can only access data within their own `/users/{userId}` document tree.
     * - Access to shared resources like `/assignments` or `/batches` is determined by membership lists
     *   (e.g., `studentUids`) denormalized on each document, enabling secure client-side queries
     *   (Query as Authorization Primitives - QAPs).
     * - Creation of academic tasks (assignments, exams) is restricted to teachers, who become the implicit owners.
     * - Creation of submissions is restricted to students, who become the owners of their work.
     * - Client-side modification of core academic structures like Batches and Courses is disabled; these are
     *   assumed to be managed by a trusted backend or admin process.
     */

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for safe updates and deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if a user is a member of a batch (either a student or a teacher).
     * Relies on denormalized maps on the batch document.
     */
    function isBatchMember(batchData) {
      return isSignedIn() && (request.auth.uid in batchData.studentMemberUids || request.auth.uid in batchData.teacherMemberUids);
    }

    /**
     * Checks if a user is a participant (student or teacher) of an academic task.
     * Relies on denormalized maps on the task document.
     */
    function isAcademicTaskParticipant(taskData) {
      return isSignedIn() && (request.auth.uid in taskData.studentUids || request.auth.uid in taskData.teacherUids);
    }

    /**
     * Checks if a user is the designated creator/teacher of an academic task.
     */
    function isTaskCreator(taskData) {
      return isSignedIn() && request.auth.uid == taskData.teacherId;
    }

    /**
     * Checks if a user is the student who owns a submission or result.
     */
    function isSubmissionOwner(submissionData) {
      return isSignedIn() && request.auth.uid == submissionData.studentId;
    }

    /**
     * Checks if a user is the teacher assigned to grade/review a submission.
     */
    function isSubmissionGrader(submissionData) {
      return isSignedIn() && request.auth.uid == submissionData.teacherId;
    }

    /**
     * Enforces immutability of core relational fields on submission-type documents during an update.
     */
    function areSubmissionKeysImmutable(parentKey) {
      return request.resource.data.studentId == resource.data.studentId
          && request.resource.data[parentKey] == resource.data[parentKey];
    }

    // -------------------------------------------------------------------------
    // User Collections
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to a user's primary account document.
     * @path /users/{userId}
     * @allow (create) A new user can create their own user document after signing up. `auth.uid` must match `userId`.
     * @deny (get) An authenticated user `user_abc` cannot read the user document for `user_xyz`.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a student's profile document.
     * @path /users/{userId}/studentProfile
     * @allow (create) A student `user_abc` can create their own student profile.
     * @deny (get) A teacher `user_xyz` cannot directly read a student's profile document.
     * @principle Enforces that a user's private profile data is only accessible to them.
     */
    match /users/{userId}/studentProfile {
      allow get: if isOwner(userId);
      allow list: if false; // This is a single document path, list is not applicable.
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a teacher's profile document.
     * @path /users/{userId}/teacherProfile
     * @allow (create) A teacher `user_abc` can create their own teacher profile.
     * @deny (get) A student `user_xyz` cannot directly read a teacher's profile document.
     * @principle Enforces that a user's private profile data is only accessible to them.
     */
    match /users/{userId}/teacherProfile {
      allow get: if isOwner(userId);
      allow list: if false; // This is a single document path, list is not applicable.
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    // -------------------------------------------------------------------------
    // Academic Structure Collections
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to academic batch documents.
     * @path /batches/{batchId}
     * @allow (get) A student or teacher whose UID is in the batch's member maps can read the document.
     * @deny (create) No client is allowed to create, update, or delete batches. This is an admin operation.
     * @principle Denormalized membership maps on the document control read access. Writes are disabled for clients.
     */
    match /batches/{batchId} {
      allow get: if isSignedIn() && isBatchMember(resource.data);
      allow list: if isSignedIn(); // Requires client to use a secure query (QAP).
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to course information.
     * @path /courses/{courseId}
     * @allow (get) Any authenticated user (student or teacher) can read course information.
     * @deny (create) No client is allowed to create, update, or delete courses. This is an admin operation.
     * @principle Course catalog information is considered public to all authenticated users. Writes are disabled for clients.
     */
    match /courses/{courseId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // Academic Task Collections
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to assignment documents.
     * @path /assignments/{assignmentId}
     * @allow (create) A teacher can create a new assignment, setting themself as the `teacherId`.
     * @deny (update) A student cannot update an assignment document. Only the creating teacher can.
     * @principle Teachers own and manage the tasks they create. Students and teachers in the relevant batch/course can read them.
     */
    match /assignments/{assignmentId} {
      allow get: if isAcademicTaskParticipant(resource.data);
      allow list: if isSignedIn(); // Requires client to use a secure query (QAP).
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isTaskCreator(resource.data);
      allow delete: if resource != null && isTaskCreator(resource.data);
    }

    /**
     * @description Controls access to project documents.
     * @path /projects/{projectId}
     * @allow (create) A teacher can create a new project, setting themself as the `teacherId`.
     * @deny (delete) A student cannot delete a project document. Only the creating teacher can.
     * @principle Teachers own and manage the tasks they create. Students and teachers in the relevant batch/course can read them.
     */
    match /projects/{projectId} {
      allow get: if isAcademicTaskParticipant(resource.data);
      allow list: if isSignedIn(); // Requires client to use a secure query (QAP).
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isTaskCreator(resource.data);
      allow delete: if resource != null && isTaskCreator(resource.data);
    }

    /**
     * @description Controls access to exam documents.
     * @path /exams/{examId}
     * @allow (create) A teacher can create a new exam, setting themself as the `teacherId`.
     * @deny (update) A student cannot modify an exam document.
     * @principle Teachers own and manage the tasks they create. Students and teachers in the relevant batch/course can read them.
     */
    match /exams/{examId} {
      allow get: if isAcademicTaskParticipant(resource.data);
      allow list: if isSignedIn(); // Requires client to use a secure query (QAP).
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isTaskCreator(resource.data);
      allow delete: if resource != null && isTaskCreator(resource.data);
    }

    /**
     * @description Controls access to internal assessment documents.
     * @path /internalAssessments/{internalAssessmentId}
     * @allow (create) A teacher can create a new assessment, setting themself as the `teacherId`.
     * @deny (update) A student cannot modify an assessment document.
     * @principle Teachers own and manage the tasks they create. Students and teachers in the relevant batch/course can read them.
     */
    match /internalAssessments/{internalAssessmentId} {
      allow get: if isAcademicTaskParticipant(resource.data);
      allow list: if isSignedIn(); // Requires client to use a secure query (QAP).
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isTaskCreator(resource.data);
      allow delete: if resource != null && isTaskCreator(resource.data);
    }

    // -------------------------------------------------------------------------
    // Submission & Result Collections
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to student assignment submissions.
     * @path /assignmentSubmissions/{submissionId}
     * @allow (create) A student can create their own submission, setting their UID as the `studentId`.
     * @deny (delete) A teacher cannot delete a student's submission. Only the student can.
     * @principle A student owns their submission, and the designated teacher can view and grade it.
     */
    match /assignmentSubmissions/{submissionId} {
      allow get: if isSubmissionOwner(resource.data) || isSubmissionGrader(resource.data);
      allow list: if isSignedIn(); // Requires client to query by studentId or teacherId (QAP).
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if resource != null && (isSubmissionOwner(resource.data) || isSubmissionGrader(resource.data)) && areSubmissionKeysImmutable('assignmentId');
      allow delete: if resource != null && isSubmissionOwner(resource.data);
    }

    /**
     * @description Controls access to student project submissions.
     * @path /projectSubmissions/{submissionId}
     * @allow (update) The student owner or teacher grader can update the submission (e.g., to add marks or feedback).
     * @deny (get) A student `user_abc` cannot read a submission belonging to student `user_xyz`.
     * @principle A student owns their submission, and the designated teacher can view and grade it.
     */
    match /projectSubmissions/{submissionId} {
      allow get: if isSubmissionOwner(resource.data) || isSubmissionGrader(resource.data);
      allow list: if isSignedIn(); // Requires client to query by studentId or teacherId (QAP).
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if resource != null && (isSubmissionOwner(resource.data) || isSubmissionGrader(resource.data)) && areSubmissionKeysImmutable('projectId');
      allow delete: if resource != null && isSubmissionOwner(resource.data);
    }

    /**
     * @description Controls access to student exam results.
     * @path /examResults/{resultId}
     * @allow (get) The student owner or teacher grader can view the exam result.
     * @deny (create) Students cannot create their own exam results; this is a teacher/admin action.
     * @principle A student owns their result data for reading, and the teacher can manage it.
     */
    match /examResults/{resultId} {
      allow get: if isSubmissionOwner(resource.data) || isSubmissionGrader(resource.data);
      allow list: if isSignedIn(); // Requires client to query by studentId or teacherId (QAP).
      // create, update, delete should likely be teacher-only, but the IR is ambiguous.
      // Defaulting to teacher can manage, student can only read.
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isSubmissionGrader(resource.data) && areSubmissionKeysImmutable('examId');
      allow delete: if resource != null && isSubmissionGrader(resource.data);
    }

    /**
     * @description Controls access to student marks for internal assessments.
     * @path /internalAssessmentMarks/{markId}
     * @allow (get) The student owner or teacher grader can view the mark.
     * @deny (create) Students cannot create their own marks; this is a teacher/admin action.
     * @principle A student owns their mark data for reading, and the teacher can manage it.
     */
    match /internalAssessmentMarks/{markId} {
      allow get: if isSubmissionOwner(resource.data) || isSubmissionGrader(resource.data);
      allow list: if isSignedIn(); // Requires client to query by studentId or teacherId (QAP).
      // create, update, delete should likely be teacher-only, but the IR is ambiguous.
      // Defaulting to teacher can manage, student can only read.
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if resource != null && isSubmissionGrader(resource.data) && areSubmissionKeysImmutable('internalAssessmentId');
      allow delete: if resource != null && isSubmissionGrader(resource.data);
    }

  }
}